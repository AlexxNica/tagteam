<% 
  # So, sometimes a feed item will be called outside the context of a hub, mainly for the homepage.
hub = @hub
if hub.blank? 
  hub = feed_item.hubs.first
end
hub_feed = (@hub_feed.blank?) ? feed_item.hub_feed_for_hub(hub.id) : @hub_feed 
%>
<tr class="feed_item hover_row" id="feed_item_<%= feed_item.id %>">
  <td class="date">
    <% if current_user && current_user.is?([:owner,:remixer,:hub_feed_item_tag_filterer,:bookmarker],hub) %>
      <span class="controls" id="feed_item_control-<%= feed_item.id %>-target" style="display: none;">
        <% if current_user.is?([:owner, :hub_feed_item_tag_filterer],hub) %>
          <span class="ui-silk ui-silk-tag-blue-add inline"></span> <%= link_to 'Add a tag to this item', hub_feed_item_hub_feed_item_tag_filters_path(hub,feed_item), :data_hub_id => hub.id, :data_type => 'AddTagFilter', :class => 'add_filter_control hub_feed_item_tag_filter' %><br/> 
        <% end %>
        <% if current_user.is?([:owner, :remixer],hub) %>
          <%= link_to(raw('<span class="ui-silk ui-silk-rss-go inline hover gray"></span> Add to a remixed feed'), custom_republished_feeds_hub_path(hub), :title => "Add #{feed_item} to a remixed feed", :class => 'dialog-show add_item_source_to_custom_republished_feed', :data_item_type => 'FeedItem', :data_item_id => feed_item.id) %><br/>
          <%= link_to(raw('<span class="ui-silk ui-silk-rss-delete inline hover gray"></span> Remove from a remixed feed'), custom_republished_feeds_hub_path(hub), :title => "Remove #{feed_item} from a remixed feed", :class => 'dialog-show remove_item_source_from_custom_republished_feed', :data_item_type => 'FeedItem', :data_item_id => feed_item.id) %><br/>
        <% end %>
        <% if hub_feed && hub_feed.feed.is_bookmarking_feed? && (current_user.is?(:owner, hub) || current_user.is?(:owner,hub_feed.feed)) %>
          <%= link_to(raw('<span class="ui-silk ui-silk-book-delete inline hover gray"></span> Remove from this bookmarking collection'), bookmarklets_remove_item_path(:hub_id => @hub, :feed_id => hub_feed.feed, :feed_item_id => feed_item), :title => "Remove #{feed_item} from this bookmarking collection", :method => :post, :confirm => "Are you sure?") %>
        <% end %>
      </span>
      <a href="#" class="ui-silk ui-silk-add inline hover gray control" id="feed_item_control-<%= feed_item.id %>">controls</a>
    <% else %>
      &nbsp;
    <% end %>
    <% cache("feed-item-tag-list-#{hub.id}-#{feed_item.id}", :expires => 30.minutes ) do %>
      <% unless feed_item.date_published.blank? %>
        <%= link_to(l(feed_item.date_published, :format => :date_and_time_short),by_date_hub_path(hub, :year => feed_item.date_published.year, :month => feed_item.date_published.month, :day => feed_item.date_published.day) ) %>
      <% end %>
    </td>
    <td width="80%" class="title">
      <%= link_to(raw(strip_tags(feed_item.title)), hub_feed_feed_item_path(hub_feed,feed_item)) %> <span class="hub_feed_title">from <%= link_to(hub_feed.display_title, hub_hub_feed_path(hub,hub_feed)) %></span>
    </td>
  </tr>

  <tr class="feed_item_tags">
    <td></td>
    <td>
      <% unless feed_item.tags_on(hub.tagging_key).empty? %>
        <%= raw feed_item.tags_on(hub.tagging_key).collect{|t| tag_display(t, :hub => hub, :hub_feed => hub_feed, :hub_feed_item => feed_item) }.join(' ') %>
      <% end %>
    </td>
  </tr>
<% end %>
